---
title: "Final Project - Abalone"
author: "econ4ever"
# date: "today"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
library(tidyverse)
library(corrplot)
library(ggplot2)
library(faraway)
library(gclus)
library(scales)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

# Abalones R' Us

## Introduction 

```{r}

abalone <- as.data.frame(read.csv("abalone.csv"))
abalone$Sex <- factor(abalone$Sex)

#removing an extra column of id numbers
abalone <- abalone[, -c(1)]

#adding a column for the age of the abalone
abalone$Age <- abalone$Rings + 1.5


```

The dataset contains `r nrow(abalone)` instances with `r length(colnames(abalone))-1` explanatory and 1 dependent variable - *Rings* all of which are numerical, except for the sex variable which is essentially a factor variable. Also, the dataset does not appear to contain any missing field which appeared to be a good fit for the analyses. The observations in the data set represent different individual abalone shells and their respective physical attributes. 

For this project, we will be using a data set on abalone caught at sea. The data consists of the following variables:

* `Sex`: F or I or M (Female, Infant, Male)
* `Length`: Longest shell measurement, mm
* `Diameter`: Measurement perpendicular to length, mm
* `Height`: With meat in shell in mm
* `Whole Weight`: Whole abalone's weight, grams
* `Shucked Weight`: Weight of abalone's meat, grams
* `Viscera Weight`: Weight of abalone's meat post-bleeding, grams
* `Shell Weight`: Weight of abalone's shell after being dried, grams
* `Rings`: Number of rings on the shell, +1.5 gives age in years

We've added a tenth variable `Age` to make explanations of the data easier.
* `Age`: Age of the abalone based on its number of rings

To begin with, we make a summary of the data.

```{r, results='markup'}
xkablesummary(abalone, title = "Summary Statistics for the Abalone Data:")
```

## SMART Questions

The SMART questions that we will be asking are:

* What physical measurement is the best predictor of the age of the abalone shell?  
* Does gender affect the size of the abalone shell? 
* Do males or females live longer among the abalone species? 
* Which weight variable is the best predictor of the age of the abalone shell? 
* How much of an abalone’s body weight is its blood? 

### Do males or females live longer in the abalone species?

There are a number of ways to check if there's a difference in the average age of the male and female abalones in our data. One way to do that is to run a hypothesis test. Before running a hypothesis test, there are a number of things we need to check for in our data. We will subset the data for males and females, check the number of observations and check for normality.

```{r, results='markup'}

femabalone <- abalone[abalone$Sex == "F", ]
malabalone <- abalone[abalone$Sex == "M", ]
infabalone <- abalone[abalone$Sex == "I", ]

qqnorm(femabalone$Age, main = "Normality Plot for Age of Female Abalones")

qqnorm(malabalone$Age, main = "Normality Plot for Age of Male Abalones")

#shapiro.test(femabalone$Age)
#shapiro.test(malabalone$Age)

```

The normality plots show that the age distribution of both male and female abalones are close to being normally distributed. Running the Shapiro-Wilkes test on both shows that neither is normally distributed. As the number of females and number of males in the data are not even, we cannot run a comparison of means using hypothesis testing. Plotting the data graphically using a boxplot shows that the average age does not differ between male and female abalones. It also shows that the oldest abalone in our sample is female, while the youngest adult abalone is male.


```{r, results='markup'}

abalone %>% ggplot(aes(x = Sex, y = Age, fill = Sex)) +
                     geom_boxplot() +
                     theme(plot.title = element_text(hjust = 0.5),
                           panel.background = element_blank(),
                           panel.border = element_rect(fill = NA),
                           panel.grid.major.y = element_line(color = "light grey"),
                           panel.grid.minor.y = element_line(color = "light grey"),
                           panel.grid.major.x = element_blank()) +
  scale_y_continuous(breaks = c(seq(0,35, by=2.5),9999)) +
  labs(x = "Sex of the Abalone", y = "Age in Years", title = "Age vs Sex in Abalones")

```

```{r}

sexchi <- chisq.test(abalone$Sex, abalone$Age)
#sexchi

```
Running a chi-squared test on the variables `Sex` and `Age` shows that there is a statistically significant association between `Age` and `Sex`. However, if we look back at the graph above, it becomes obvious that the class `I` (infant) in the variable `Sex` may be driving the association, as male and female abalones ages seem to be evenly distributed. 

The data shows that there is no gender disparity when it comes to the lifespan of the abalone in our sample. There may be a prime harvesting age for abalones past which they are no longer considered a delicacy which may be creating an upper limit in our data set. 

### What physical measurement is the best predictor of age in an abalone?

First, we would like to use `corplot` to visualize the dataset to have a better overview of that.

```{r,results='markup'}
#make the corplot
abalone2 <- abalone[-c(1)]
M <- cor(abalone2)
corplot1 <- corrplot(M,method = "number",title = "Corrplot of physical measurement")
corplot1
```
Then, we would like to create a scatterplot matrix based on this dataset.

```{r,results='markup'}
scatterplot1 <-scatterplot(Age~Length, data = abalone,
                           xlab = "Length", ylab = "Age", main="scatterplot of length and age")
scatterplot2 <-scatterplot(Age~Diameter, data = abalone,
                           xlab = "Diameter", ylab = "Age", main="scatterplot of diameter and age")
scatterplot3 <-scatterplot(Age~Height, data = abalone,
                           xlab = "Height", ylab = "Age", main="scatterplot of height and age")
scatterplot4 <-scatterplot(Age~WholeWeight, data = abalone,
                           xlab = "WholeWeight", ylab = "Age", main="scatterplot of whole weight and age")
scatterplot5 <-scatterplot(Age~ShuckedWeight, data = abalone,
                           xlab = "ShuckedWeight", ylab = "Age", main="scatterplot of shucked weight and age")
scatterplot6 <-scatterplot(Age~VisceraWeight, data = abalone,
                           xlab = "VisceraWeight", ylab = "Age", main="scatterplot of viscera weight and age")
scatterplot7 <-scatterplot(Age~ShellWeight, data = abalone,
                           xlab = "shell weight", ylab = "Age", main="scatterplot of shell weight and age")
```

It is very hard to tell a very clear relationship between `age` and other physical measurement. Therefore, we would like to run a linear regression to find the best predictor of the age of abalone shell.

```{r,results='markup'}
lmphysical <- lm(Rings~Length+Diameter+Height+WholeWeight+ShuckedWeight+VisceraWeight+ShellWeight, data = abalone)
summary(lmphysical)

#we ran a bunch of regressions and checked the R-squared values and VIF values for each one to find the best linear regression model
#the regressions were basically running each variable on the rest (except for Age since Age and Rings are perfectly collinear) to see which ones had VIF values under 10 and were statistically significant
#we're left with the model Length~Age+Diameter+Height+WholeWeight+Sex in which Height is not statistically significant and taking it out doesn't affect the model much and doesn't change the R-squared value but we'll take it out during the analysis

#lm2 <- lm(Age~Length+Diameter+Height+WholeWeight+Sex, data=abalone)

lm3 <- lm(Length~Age+Diameter+Height+WholeWeight+Sex, data=abalone)

#lm4 <- lm(Diameter~Rings+Height+WholeWeight+ShuckedWeight+VisceraWeight+ShellWeight, data=abalone)

#lm5 <- lm(Height~Rings+Diameter+WholeWeight+ShuckedWeight+VisceraWeight+ShellWeight, data=abalone)

#lm6 <- lm(WholeWeight~Rings+Diameter+Height, data=abalone)

#summary(lm2)
summary(lm3)
#summary(lm4)
#summary(lm5)
#summary(lm6)

vif(lm3)

```

According to the result of the regression, we can get that the equation is as following: \
`Rings` = 2.985-1.572`Length`+13.361`Diameter`+11.826`Height`+9.247`WholeWeight`-20.214`ShuckedWeight`-9.830`VisceraWeight`+8.576`ShellWeight`\
Because we get a very small P-value and the adjusted R-squared is 0.5268, we can say that this model is statistically significant.
Meanwhile, all of the variables except `Length` are statistically significant. 
We can make the conclusion that the best predictor in physical measurement is `ShuckedWeight`, which means the weight of meat.

### Does gender affect the size of the abalone shell?

To evaluate this question, we will first look at boxplots for Length, Diameter, and Height seperated by Sex. Then we will run anova tests on the previous three variables, and if necessary we will use a Tukey post hoc test.

```{r, results='markup'}


bp.Sex_Length <- ggplot(abalone, aes(x=Sex, y=Length, fill=Sex, group=Sex)) +
         geom_boxplot(outlier.shape=8, outlier.color='red') + 
         theme(plot.title = element_text(hjust = 0.5),
         panel.background = element_blank(),
         panel.border = element_rect(fill = NA),
         panel.grid.major.y = element_line(color = "light grey"),
         panel.grid.minor.y = element_line(color = "light grey"),
         panel.grid.major.x = element_blank()) 

bp.Sex_Length <- ggplot(abalone, aes(x=Sex, y=Length, color=Sex, group=Sex)) +
         geom_boxplot(outlier.shape=8, outlier.color='red') +
         stat_boxplot(geom='errorbar', width=0.3) +

         xlab('Sex') +
         ylab('Length (mm)') +
         ggtitle('Length of Abalone Shells by Sex')

bp.Sex_Length
Anova.Sex_Length <- aov(Length ~ Sex, data = abalone)
summary(Anova.Sex_Length)
tukey.Sex_Length <- TukeyHSD(Anova.Sex_Length)
tukey.Sex_Length



bp.Sex_Diameter <- ggplot(abalone, aes(x=Sex, y=Diameter, fill=Sex, group=Sex))
bp.Sex_Diameter <- ggplot(abalone, aes(x=Sex, y=Diameter, color=Sex, group=Sex)) +
         geom_boxplot(outlier.shape=8, outlier.color='red') +
         theme(plot.title = element_text(hjust = 0.5),
         panel.background = element_blank(),
         panel.border = element_rect(fill = NA),
         panel.grid.major.y = element_line(color = "light grey"),
         panel.grid.minor.y = element_line(color = "light grey"),
         panel.grid.major.x = element_blank()) +
         xlab('Sex') +
         ylab('Diameter (mm)') +
         ggtitle('Diameter of Abalone Shells by Sex')
         
bp.Sex_Diameter
Anova.Sex_Diameter <- aov(Diameter ~ Sex, data = abalone)
summary(Anova.Sex_Diameter)   
tukey.Sex_Diameter <- TukeyHSD(Anova.Sex_Diameter)
tukey.Sex_Diameter


bp.Sex_Height <- ggplot(abalone, aes(x=Sex, y=Height, fill=Sex, group=Sex))
bp.Sex_Height <- ggplot(abalone, aes(x=Sex, y=Height, color=Sex, group=Sex)) +
         geom_boxplot(outlier.shape=8, outlier.color='red') +
         theme(plot.title = element_text(hjust = 0.5),
         panel.background = element_blank(),
         panel.border = element_rect(fill = NA),
         panel.grid.major.y = element_line(color = "light grey"),
         panel.grid.minor.y = element_line(color = "light grey"),
         panel.grid.major.x = element_blank()) +
         xlab('Sex') +
         ylab('Height (mm)') +
         ggtitle('Height of Abalone Shells by Sex')
         
bp.Sex_Height         
Anova.Sex_Height <- aov(Height ~ Sex, data = abalone)
summary(Anova.Sex_Height)         
tukey.Sex_Height <- TukeyHSD(Anova.Sex_Height)
tukey.Sex_Height

```

Now, we would like to draw a residual plot to see if the dataset satisfies the homoskedasticity or not.

```{r,results='markup'}
res <- resid(lmphysical)
residualplot1 <- plot(fitted(lmphysical),res,
                      xlab = "fitted value", ylab = "residuals", main = "residual plot") + 
  abline(0,0)
```


### Which weight variable is the best predictor of the age of the abalone shell? 

```{r}
lm1 <- lm(data=abalone, Rings ~ WholeWeight+ShuckedWeight+VisceraWeight+ShellWeight)
summary(lm1)

lm2 <- lm(data=abalone, Rings ~ WholeWeight)
summary(lm2)

lm3 <- lm(data=abalone, Rings ~ ShuckedWeight)
summary(lm3)

lm4 <- lm(data=abalone, Rings ~ VisceraWeight)
summary(lm4)

lm5 <- lm(data=abalone, Rings ~ ShellWeight)
summary(lm5)
```

### How much of an abalone’s body weight is its blood?
```{r}
abalone$'BloodPercentage' <- abalone$VisceraWeight/abalone$ShuckedWeight
mean(abalone$`BloodPercentage`)
```

To answer this question, we created a new  variable entitled `BloodPercentage` that is the amount of weight from viscera divided by the total weight of the meat. 

The mean of this variable is `r mean(abalone$BloodPercentage)`, indicating that `r mean(abalone$BloodPercentage)*100`% of the average abalone's weight is from the viscera organs.

```{r, results='markup'}
# Histogram #
ggplot(data=abalone, aes(x=BloodPercentage)) + geom_histogram(color='red') + ggtitle("Percentage of Abalone Weight From Viscera") + xlab("% Viscera Weight") + ylab("Count") + scale_x_continuous(breaks = scales::pretty_breaks(n = 15), labels = percent_format(accuracy = 1)) + geom_vline(aes(xintercept=mean(BloodPercentage)), color='blue')
```

## Model Building

Model Assumptions: 

1. `Rings` are normally distributed. 
```{r, results='markup'}
# Q Q plot #
qqnorm(abalone$Rings, main="Q-Q Plot of Rings in Abalone Shells")

# Histogram #
ggplot(data=abalone, aes(x=Rings)) + geom_histogram(bins=30, color='blue') + ggtitle("Distribution of Ring Count in Abalone Shells") + xlab("Number of Rings") + ylab("Count")
```

2. Functional form: there is a linear relationship between `Rings` and the independent variables.
```{r, results='markup'}

# All LM plots #
fullmodel <- lm(data=abalone, Rings~.)
plot(fullmodel)

# Scatterplot #
# We can choose what variable we want to plot with Rings here to visualize correct functional form #
ggplot(abalone, aes(x=Rings, y=WholeWeight)) + geom_point(color='blue') + ggtitle("Whole Weight vs. Rings") + xlab("Rings") + ylab("Whole Weight") + geom_smooth(method='lm')
```

3. Homoscedasticity 


4. Multicollinearity 


## Conclusion




